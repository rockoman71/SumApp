node { 
    def app
    def tag = '${BUILD_NUMBER}'
    def dockerRegistry = 'mycluster.icp:8500'
    def image = 'mycluster.icp:8500/demo/sumapp'
    def namespace = 'devops'
    
    stage('Get Source') {
		   git "https://github.com/rockoman71/SumApp.git"
	  }
    
    stage('Build Maven project') {
		  
		  sh "mvn -B clean package"
		  
	  }
    
    stage('Build image') {
        /* This builds the actual image; synonymous to
         * docker build on the command line */

        app = docker.build(image)
    } 
   
    stage('Build Docker image test') {
            docker.withRegistry("https://mycluster.icp:8500",'docker') {
	                    app.push("${env.BUILD_NUMBER}")
                            app.push("latest")
	    }
    }
    stage('Build Docker image') {
		    
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'docker', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
            sh 'docker login ${dockerRegistry} -u $USERNAME -p $PASSWORD'
	  }	  
			  sh "docker build -t ${image}:${tag} ."
			  sh "docker push ${image}:${tag}"
			  sh "docker tag ${image}:${tag} ${image}:latest"
			  sh "docker push ${image}:latest"
		  
   }       
}
